language: rust
env:
  global:
    - REPO=yarner-block-links

os:
  - linux
  - windows
  - osx

rust:
  - stable

branches:
  only:
    - main
    - "/^\\d+\\.\\d+\\.\\d+/"

script:
  - rustup component add rustfmt clippy
  - cargo fmt -- --check
  - cargo clippy --all-targets -- --deny warnings
  - cargo test --verbose

# Need to cache the whole `.cargo` directory to keep .crates.toml for
# cargo-update to work
cache:
  directories:
    - /home/travis/.cargo

# But don't cache the cargo registry
before_cache:
  - rm -rf /home/travis/.cargo/registry

before_deploy:
  - cargo build --release
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      cp -f target/release/${REPO} . > /dev/null;
      tar -czf ${REPO}-${TRAVIS_TAG}-${TRAVIS_OS_NAME}.tar.gz ${REPO};
    fi
  - |
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      cp -f target/release/${REPO} . > /dev/null;
      tar -czf ${REPO}-${TRAVIS_TAG}-${TRAVIS_OS_NAME}.tar.gz ${REPO};
    fi
  - |
    if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      cp -f target/release/${REPO}.exe . > /dev/null;
      tar -czf ${REPO}-${TRAVIS_TAG}-${TRAVIS_OS_NAME}.tar.gz ${REPO}.exe;
    fi

deploy:
  provider: releases
  skip_cleanup: true
  token:
    secure: 71Yg4te0hh9WWFiZXVRdJdrLgMIn7SFwWcCelaGiu7U7R9+ZgeWWmHb7D/DGM2hYYHRUwK0cUSkSIsnQWUaDGetQ3g0EU6MZT2IH6zzKcPyyMY2hpNE0ANhtwdXodVs38p+Qzb5NNxfninpcCIDkeQEFmUzTQ+SoucO57e9hKkz6m/1OT4RkLzysk1yqeyWG8+BWlTss/tpnzW3zEF6gZplqhiXY6ZTqvqIVtj022bSUzQwnbAYDxOquRvu35nGcruPzvDUNszShPV+zeDlhNYo9fKKQt0u1n8CnHVaMlBOcWWXm9JIGr1AFiAOhFLi3LTvQwxIIP+rN9pAxoAsa5zxBu/VSsPNsBgv+ZqOc/sM6eQl0MkdROHSrjexqKaRRue/SX5QlJiOgYjFs3L6Xx3eSkoXLR0IID6mlcbwMy8SBuZdKJArO6x3yeufy7F7mAdNTsX54dsoCzwhmFjowpy+DRnvryRfsQy1/E3HWv5+OgHTr/X0UO7pB05B812J67xJwNLov0CwoFXHxjtwnePbGECVAureQRnXtGZnM0NPPzMBBPLlm1dg8P+TI46bBGNuVfSMQoFieUlORRBJ6NRM/hnK8RiFnzOkRQlGluOuCZGtYZfenCV5fF8Gl326GeIGvPQpMn2bQI9JGwvHa8w11sFfXFjTr4MtQ50jlrjQ=
  file: ${REPO}-${TRAVIS_TAG}-${TRAVIS_OS_NAME}.tar.gz
  on:
    tags: true
    all_branches: true
